<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YABAI è¦çš®å”®åƒ¹è©¦ç®—å™¨ï¼ˆå¤š SKUï¼‰</title>
  <style>
    :root { --accent: linear-gradient(45deg,#ff6b35,#f7931e); --card-bg: linear-gradient(45deg,#e8f5e8,#d4edda); }
    body { font-family: Arial, Helvetica, sans-serif; max-width:1100px; margin:28px auto; padding:18px; background:#f9f9f9; color:#222; }
    h1 { text-align:center; color:#333; margin-bottom:14px; }
    .grid { display:grid; grid-template-columns:1fr 340px; gap:18px; align-items:start; }
    .panel { background:#fff; padding:14px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; text-align:left; border-bottom:1px solid #eee; vertical-align:middle; }
    th { font-weight:700; background:#fafafa; font-size:13px; }
    input[type="number"], select, input[type="text"] { width:100%; padding:6px 8px; font-size:14px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; }
    .small { width:80px; }
    .actions { display:flex; gap:8px; margin-top:10px; }
    button.primary { background:var(--accent); color:#fff; padding:10px 12px; border:none; font-size:14px; border-radius:8px; cursor:pointer; }
    button.ghost { background:transparent; border:1px solid #ddd; padding:8px 10px; border-radius:8px; cursor:pointer; }
    .muted { color:#666; font-size:13px; }
    .good { color:green; } .bad { color:red; }
    .settings-row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
    .settings-row label { flex:1; font-size:13px; }
    .setting-input { width:100px; }
    .total { font-weight:700; font-size:16px; display:flex; justify-content:space-between; padding-top:8px; }
    @media (max-width:940px){ .grid { grid-template-columns:1fr; } .panel { padding:12px; } .small { width:70px; } }
  </style>
</head>
<body>
  <h1>ğŸ›’ YABAI è¦çš®å”®åƒ¹è©¦ç®—å™¨ï¼ˆå¤š SKUï¼‰</h1>

  <div class="grid">
    <div class="panel" id="skuPanel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div>
          <strong>å•†å“åˆ—è¡¨ï¼ˆSKU / æ‰¹æ¬¡ï¼‰</strong>
          <div class="muted">æ–°å¢å¤šå€‹å•†å“æˆ–æ‰¹æ¬¡ï¼Œç³»çµ±æœƒé¡¯ç¤ºæ¯åˆ—æ˜ç´°èˆ‡åˆè¨ˆã€‚</div>
        </div>
        <div>
          <button id="addRowBtn" class="primary" title="æ–°å¢å•†å“">ï¼‹ æ–°å¢</button>
        </div>
      </div>

      <div style="overflow:auto;">
        <table id="skuTable" aria-label="å•†å“æ¸…å–®">
          <thead>
            <tr>
              <th style="width:160px">åç¨±</th>
              <th style="width:110px">æˆæœ¬</th>
              <th style="width:110px">å”®åƒ¹</th>
              <th style="width:90px">æ•¸é‡</th>
              <th style="width:120px">å…é‹</th>
              <th style="width:80px">ä¿ƒéŠ·</th>
              <th style="width:80px">è¦å¹£</th>
              <th style="width:80px">é•·å‚™è²¨</th>
              <th style="width:140px">æ”¶å…¥ / æ‰‹çºŒ / æ·¨åˆ©</th>
              <th style="width:120px">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="skuBody">
            <!-- rows injected -->
          </tbody>
        </table>
      </div>

      <div class="total" style="margin-top:12px;">
        <div>åˆè¨ˆ</div>
        <div id="totalsArea">
          <span id="totalRevenue">$0</span> /
          <span id="totalFees">$0</span> /
          <span id="totalProfit" class="muted">$0</span> /
          <span id="totalMargin">0.0%</span>
        </div>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button id="calcAllBtn" class="primary">ğŸš€ è¨ˆç®—</button>
        <button id="copyAllBtn" class="ghost">ğŸ“‹ è¤‡è£½çµæœ</button>
        <button id="clearBtn" class="ghost">æ¸…é™¤å…¨éƒ¨</button>
      </div>
    </div>

    <div class="panel" id="settingPanel">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>è¨­å®šé¢æ¿ï¼ˆè²»ç‡ï¼‰</strong>
        <div class="muted">è®Šæ›´æœƒå³æ™‚å¥—ç”¨ä¸¦å„²å­˜</div>
      </div>

      <div style="margin-top:12px;">
        <div class="settings-row">
          <label>æˆäº¤æ‰‹çºŒè²»ï¼ˆä¸€èˆ¬ï¼‰<input id="feeBase" class="setting-input" type="number" step="0.001" min="0" /></label>
          <label>æˆäº¤æ‰‹çºŒè²»ï¼ˆä¿ƒéŠ·ï¼‰<input id="feePromo" class="setting-input" type="number" step="0.001" min="0" /></label>
        </div>

        <div class="settings-row">
          <label>è¦å¹£æŠ˜æŠµï¼ˆæ¸›å¹…ï¼‰<input id="feeShrimp" class="setting-input" type="number" step="0.001" min="0" /></label>
          <label>æµæ°´æœå‹™è²»ï¼ˆ%ï¼‰<input id="feeFlow" class="setting-input" type="number" step="0.001" min="0" /></label>
        </div>

        <div class="settings-row">
          <label>ä¿ƒéŠ·é¡å¤–è²»ï¼ˆ%ï¼‰<input id="feePromoExtra" class="setting-input" type="number" step="0.001" min="0" /></label>
          <label>é•·å‚™è²¨è²»ï¼ˆ%ï¼‰<input id="feeLong" class="setting-input" type="number" step="0.001" min="0" /></label>
        </div>

        <div class="muted" style="margin-top:8px;">å…é‹æ–¹æ¡ˆç‚ºæ¯åˆ—ç¨ç«‹è¨­å®šï¼šæ–¹æ¡ˆä¸€ = 6%ï¼ˆæŒ‰æ”¶å…¥ï¼‰ï¼Œæ–¹æ¡ˆäºŒ = 60å…ƒ/ç­†ã€‚</div>

        <div style="margin-top:12px;">
          <button id="resetSettingsBtn" class="ghost">é‚„åŸé è¨­è²»ç‡</button>
          <button id="saveSettingsBtn" class="primary" style="margin-left:6px;">å„²å­˜è¨­å®š</button>
        </div>
      </div>

      <hr style="margin:12px 0">

      <div>
        <strong>å¿«é€Ÿèªªæ˜</strong>
        <ol class="muted" style="padding-left:16px; margin-top:6px;">
          <li>æ¯åˆ—å¯è¨­å®šæ˜¯å¦ç‚ºä¿ƒéŠ· / ä½¿ç”¨è¦å¹£ / é•·å‚™è²¨ï¼Œä¸¦é¸æ“‡å…é‹æ–¹å¼ã€‚</li>
          <li>è¨­å®šé¢æ¿è®Šæ›´æœƒå³æ™‚ç”Ÿæ•ˆä¸¦å„²å­˜åœ¨ localStorageã€‚</li>
          <li>æ–°å¢å¤šåˆ—å¾Œå¯ä¸€æ¬¡è¨ˆç®—å…¨éƒ¨åˆè¨ˆï¼Œæˆ–ä½¿ç”¨ã€Œè¤‡è£½çµæœã€å°‡æ˜ç´°è²¼åˆ°æ–‡ä»¶/èŠå¤©ã€‚</li>
        </ol>
      </div>
    </div>
  </div>

  <script>
    (function(){
      /* ---------- helpers ---------- */
      function q(id){ return document.getElementById(id); }
      function toNum(v, fallback=0){ const n = Number(v); return Number.isFinite(n) ? n : fallback; }
      function money(n){ return '$' + Math.round(n).toLocaleString(); }
      function pct(n){ return (n*100).toFixed(1) + '%'; }

      /* ---------- localStorage keys & defaults ---------- */
      const LS_KEY = 'yabai:multisku:v1';
      const DEFAULTS = {
        settings: {
          feeBase: 0.06,
          feePromo: 0.075,
          feeShrimp: 0.015,
          feeFlow: 0.025,
          feePromoExtra: 0.02,
          feeLong: 0.03
        },
        rows: [
          { id: genId(), name: 'ç¤ºä¾‹å•†å“ A', cost:500, price:1000, qty:1, freeship:'1', promo:false, shrimp:true, long:false }
        ]
      };

      function genId(){ return 'r' + Math.random().toString(36).slice(2,9); }

      /* ---------- state ---------- */
      let state = loadState();
      // last computed results (for copy)
      let lastResults = { rows: [], totals: {} };

      /* ---------- elements ---------- */
      const skuBody = q('skuBody');
      const addRowBtn = q('addRowBtn');
      const calcAllBtn = q('calcAllBtn');
      const clearBtn = q('clearBtn');
      const totalRevenueEl = q('totalRevenue');
      const totalFeesEl = q('totalFees');
      const totalProfitEl = q('totalProfit');
      const totalMarginEl = q('totalMargin');
      const copyAllBtn = q('copyAllBtn');

      const feeBaseEl = q('feeBase');
      const feePromoEl = q('feePromo');
      const feeShrimpEl = q('feeShrimp');
      const feeFlowEl = q('feeFlow');
      const feePromoExtraEl = q('feePromoExtra');
      const feeLongEl = q('feeLong');
      const resetSettingsBtn = q('resetSettingsBtn');
      const saveSettingsBtn = q('saveSettingsBtn');

      /* ---------- load & save ---------- */
      function loadState(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(raw){
            const parsed = JSON.parse(raw);
            if(parsed && Array.isArray(parsed.rows) && parsed.settings) return parsed;
          }
        }catch(e){}
        return JSON.parse(JSON.stringify(DEFAULTS));
      }

      function saveState(){
        try{
          localStorage.setItem(LS_KEY, JSON.stringify(state));
        }catch(e){ console.warn('save failed', e); }
      }

      /* ---------- render rows ---------- */
      function renderRows(){
        skuBody.innerHTML = '';
        state.rows.forEach(row => {
          const tr = document.createElement('tr');
          tr.dataset.id = row.id;
          tr.innerHTML = `
            <td><input type="text" class="name" value="${escapeHtml(row.name||'')}" /></td>
            <td><input type="number" class="cost small" min="0" step="1" value="${toNum(row.cost,0)}" /></td>
            <td><input type="number" class="price small" min="0" step="1" value="${toNum(row.price,0)}" /></td>
            <td><input type="number" class="qty small" min="1" step="1" value="${Math.max(1,Math.floor(toNum(row.qty,1)))}" /></td>
            <td>
              <select class="freeship">
                <option value="1"${row.freeship==='1' ? ' selected':''}>æ–¹æ¡ˆä¸€ï¼š6%</option>
                <option value="2"${row.freeship==='2' ? ' selected':''}>æ–¹æ¡ˆäºŒï¼š60å…ƒ/ç­†</option>
              </select>
            </td>
            <td style="text-align:center"><input type="checkbox" class="promo"${row.promo ? ' checked':''} /></td>
            <td style="text-align:center"><input type="checkbox" class="shrimp"${row.shrimp ? ' checked':''} /></td>
            <td style="text-align:center"><input type="checkbox" class="long"${row.long ? ' checked':''} /></td>
            <td class="summary muted" style="white-space:nowrap"></td>
            <td style="text-align:center">
              <button class="removeBtn ghost">åˆªé™¤</button>
              <button class="copyRowBtn ghost" title="è¤‡è£½æ­¤åˆ—æ˜ç´°">è¤‡è£½</button>
            </td>
          `;
          skuBody.appendChild(tr);
        });
        attachRowListeners();
      }

      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      /* ---------- row events (delegation) ---------- */
      function attachRowListeners(){
        skuBody.querySelectorAll('input, select, button').forEach(el=>{
          el.removeEventListener('input', onRowInput);
          el.removeEventListener('change', onRowInput);
          el.addEventListener('input', onRowInput);
          el.addEventListener('change', onRowInput);
        });

        skuBody.querySelectorAll('.removeBtn').forEach(btn=>{
          btn.removeEventListener('click', onRemoveRow);
          btn.addEventListener('click', onRemoveRow);
        });

        skuBody.querySelectorAll('.copyRowBtn').forEach(btn=>{
          btn.removeEventListener('click', onCopyRow);
          btn.addEventListener('click', onCopyRow);
        });
      }

      function onRowInput(e){
        const tr = e.target.closest('tr');
        if(!tr) return;
        const id = tr.dataset.id;
        const row = findRow(id);
        if(!row) return;

        row.name = tr.querySelector('.name').value;
        row.cost = toNum(tr.querySelector('.cost').value, 0);
        row.price = toNum(tr.querySelector('.price').value, 0);
        row.qty = Math.max(1, Math.floor(toNum(tr.querySelector('.qty').value, 1)));
        row.freeship = tr.querySelector('.freeship').value;
        row.promo = !!tr.querySelector('.promo').checked;
        row.shrimp = !!tr.querySelector('.shrimp').checked;
        row.long = !!tr.querySelector('.long').checked;

        saveState();
        scheduleCalc();
      }

      function onRemoveRow(e){
        const tr = e.target.closest('tr');
        if(!tr) return;
        const id = tr.dataset.id;
        state.rows = state.rows.filter(r=>r.id !== id);
        saveState();
        renderRows();
        scheduleCalc();
      }

      function onCopyRow(e){
        const tr = e.target.closest('tr');
        if(!tr) return;
        const id = tr.dataset.id;
        const res = lastResults.rows.find(r=>r.id===id);
        if(!res){
          alert('å°šæœªè¨ˆç®—æˆ–æ‰¾ä¸åˆ°æ­¤åˆ—çµæœï¼Œè«‹å…ˆæŒ‰ã€Œè¨ˆç®—ã€ã€‚');
          return;
        }
        const text = `å•†å“ï¼š${res.name}\næ•¸é‡ï¼š${res.qty}\nå”®åƒ¹ï¼š${res.price}\næ”¶å…¥ï¼š${Math.round(res.revenue)}\næ‰‹çºŒè²»ï¼š${Math.round(res.fees)}\næ·¨åˆ©ï¼š${Math.round(res.profit)}\nåˆ©æ½¤ç‡ï¼š${res.margin.toFixed(1)}%`;
        copyTextToClipboard(text, e.target);
      }

      function findRow(id){ return state.rows.find(r=>r.id===id); }

      /* ---------- add / clear ---------- */
      addRowBtn.addEventListener('click', ()=>{
        const r = { id: genId(), name:'æ–°å•†å“', cost:0, price:0, qty:1, freeship:'1', promo:false, shrimp:true, long:false };
        state.rows.push(r);
        saveState();
        renderRows();
        scheduleCalc();
      });

      clearBtn.addEventListener('click', ()=>{
        if(!confirm('æ¸…é™¤å…¨éƒ¨å•†å“ï¼Ÿæ­¤æ“ä½œæœƒåˆªé™¤æ‰€æœ‰åˆ—ã€‚')) return;
        state.rows = [];
        saveState();
        renderRows();
        scheduleCalc();
      });

      /* ---------- settings render / events ---------- */
      function renderSettings(){
        const s = state.settings;
        feeBaseEl.value = s.feeBase;
        feePromoEl.value = s.feePromo;
        feeShrimpEl.value = s.feeShrimp;
        feeFlowEl.value = s.feeFlow;
        feePromoExtraEl.value = s.feePromoExtra;
        feeLongEl.value = s.feeLong;
      }

      function applySettingsFromInputs(){
        state.settings.feeBase = Math.max(0, toNum(feeBaseEl.value, state.settings.feeBase));
        state.settings.feePromo = Math.max(0, toNum(feePromoEl.value, state.settings.feePromo));
        state.settings.feeShrimp = Math.max(0, toNum(feeShrimpEl.value, state.settings.feeShrimp));
        state.settings.feeFlow = Math.max(0, toNum(feeFlowEl.value, state.settings.feeFlow));
        state.settings.feePromoExtra = Math.max(0, toNum(feePromoExtraEl.value, state.settings.feePromoExtra));
        state.settings.feeLong = Math.max(0, toNum(feeLongEl.value, state.settings.feeLong));
        saveState();
      }

      feeBaseEl.addEventListener('input', ()=>{ applySettingsFromInputs(); scheduleCalc(); });
      feePromoEl.addEventListener('input', ()=>{ applySettingsFromInputs(); scheduleCalc(); });
      feeShrimpEl.addEventListener('input', ()=>{ applySettingsFromInputs(); scheduleCalc(); });
      feeFlowEl.addEventListener('input', ()=>{ applySettingsFromInputs(); scheduleCalc(); });
      feePromoExtraEl.addEventListener('input', ()=>{ applySettingsFromInputs(); scheduleCalc(); });
      feeLongEl.addEventListener('input', ()=>{ applySettingsFromInputs(); scheduleCalc(); });

      resetSettingsBtn.addEventListener('click', ()=>{
        if(!confirm('é‚„åŸç‚ºé è¨­è²»ç‡ï¼Ÿ')) return;
        state.settings = JSON.parse(JSON.stringify(DEFAULTS.settings));
        renderSettings();
        saveState();
        scheduleCalc();
      });

      saveSettingsBtn.addEventListener('click', ()=>{
        applySettingsFromInputs();
        alert('å·²å„²å­˜è¨­å®š');
      });

      /* ---------- calculation ---------- */
      let calcTimer;
      function scheduleCalc(){
        clearTimeout(calcTimer);
        calcTimer = setTimeout(calculateAll, 160);
      }

      function calculateAll(){
        const s = state.settings;
        let totalRevenue = 0, totalFees = 0, totalProfit = 0;
        const rowsResults = [];

        // iterate rows and compute per row
        state.rows.forEach(row=>{
          const revenue = row.price * row.qty;
          let trans = row.promo ? s.feePromo : s.feeBase;
          if(row.shrimp) trans = Math.max(0, trans - s.feeShrimp);
          const trans_fee = revenue * trans;
          const flow_fee = revenue * s.feeFlow;
          const free_fee = row.freeship === '1' ? revenue * 0.06 : 60 * row.qty;
          const promo_fee = row.promo ? revenue * s.feePromoExtra : 0;
          const long_fee = row.long ? revenue * s.feeLong : 0;

          const fees = trans_fee + flow_fee + free_fee + promo_fee + long_fee;
          const profit = revenue - fees - (row.cost * row.qty);
          const margin = revenue > 0 ? (profit / revenue * 100) : 0;

          rowsResults.push({
            id: row.id,
            name: row.name,
            qty: row.qty,
            price: row.price,
            revenue, fees, profit, margin
          });

          totalRevenue += revenue;
          totalFees += fees;
          totalProfit += profit;
        });

        const totalMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;

        // update UI per-row summary cells
        skuBody.querySelectorAll('tr').forEach(tr=>{
          const id = tr.dataset.id;
          const r = rowsResults.find(x=>x.id===id);
          const summaryCell = tr.querySelector('.summary');
          if(r){
            summaryCell.textContent = `${money(r.revenue)} / ${money(r.fees)} / ${money(r.profit)}`;
            summaryCell.className = 'summary ' + (r.profit >= 0 ? 'good' : 'bad');
          } else {
            summaryCell.textContent = '';
          }
        });

        // update totals UI
        totalRevenueEl.textContent = money(totalRevenue);
        totalFeesEl.textContent = money(totalFees);
        totalProfitEl.textContent = money(totalProfit);
        totalProfitEl.className = totalProfit >= 0 ? 'good' : 'bad';
        totalMarginEl.textContent = totalMargin.toFixed(1) + '%';

        // store lastResults for copy
        lastResults = { rows: rowsResults, totals: { revenue: totalRevenue, fees: totalFees, profit: totalProfit, margin: totalMargin } };

        saveState();
        return lastResults;
      }

      calcAllBtn.addEventListener('click', calculateAll);

      /* ---------- copy functionality ---------- */
      function copyTextToClipboard(text, triggerBtn){
        // try navigator.clipboard
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(text).then(()=>{
            const btn = triggerBtn || copyAllBtn;
            const original = btn.textContent;
            btn.textContent = 'å·²è¤‡è£½';
            setTimeout(()=> btn.textContent = original, 1400);
          }).catch(err=>{
            fallbackCopy(text, triggerBtn);
          });
        } else {
          fallbackCopy(text, triggerBtn);
        }
      }

      function fallbackCopy(text, triggerBtn){
        // fallback: create textarea and execCommand
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try {
          const ok = document.execCommand('copy');
          const btn = triggerBtn || copyAllBtn;
          const original = btn.textContent;
          btn.textContent = ok ? 'å·²è¤‡è£½' : 'è¤‡è£½å¤±æ•—';
          setTimeout(()=> btn.textContent = original, 1400);
        } catch(e){
          alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹æ–‡å­—ï¼š\n\n' + text);
        } finally {
          document.body.removeChild(ta);
        }
      }

      copyAllBtn.addEventListener('click', ()=>{
        // ensure we have latest results
        const results = calculateAll();
        if(!results || !Array.isArray(results.rows)) return alert('å°šæœªæœ‰è¨ˆç®—çµæœ');
        // build text
        let lines = [];
        lines.push('å•†å“æ˜ç´°ï¼š');
        results.rows.forEach((r, idx)=>{
          lines.push(`${idx+1}. ${r.name}  æ•¸é‡:${r.qty} å”®åƒ¹:${r.price} æ”¶å…¥:${Math.round(r.revenue)} æ‰‹çºŒ:${Math.round(r.fees)} æ·¨åˆ©:${Math.round(r.profit)} åˆ©æ½¤ç‡:${r.margin.toFixed(1)}%`);
        });
        lines.push('');
        lines.push(`åˆè¨ˆ æ”¶å…¥:${Math.round(results.totals.revenue)} æ‰‹çºŒ:${Math.round(results.totals.fees)} æ·¨åˆ©:${Math.round(results.totals.profit)} åˆ©æ½¤ç‡:${results.totals.margin.toFixed(1)}%`);
        const text = lines.join('\n');
        copyTextToClipboard(text, copyAllBtn);
      });

      /* ---------- initial render/load ---------- */
      function init(){
        renderRows();
        renderSettings();
        // initial calc
        calculateAll();
      }

      // load existing state into UI (render settings already called)
      init();

      /* ---------- utilities ---------- */
      // keep calculation reactive: schedule on input changes inside rows
      let debounceTimer;
      skuBody.addEventListener('input', ()=>{
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(()=> calculateAll(), 180);
      });
      skuBody.addEventListener('change', ()=>{
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(()=> calculateAll(), 180);
      });

    })();
  </script>
</body>
</html>
